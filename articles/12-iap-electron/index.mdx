---
title: In-App Purchases in Electron
tags:
  - development
  - webdev
keywords:
  - electron
  - in-app purchases
  - mac app store
  - electron-builder
  - app store connect
  - sandbox
  - subscriptions
author: kochie
jumbotron:
  src: kishore-v-9pfffR5Gvow-unsplash.jpg
  alt: iPad and Apple Pencil
blurb: A deep dive into getting into Apple's draconian walled-garden
publishedDate: 2024-10-08T21:30:00+10:00
editedDate: 2024-10-08T21:30:00+10:00
---

The only way to offer in-app purchases on the Apple Mac Store is to use Apple's
StoreKit API which provides a complete payment solution for MacOS apps.
Fortunately Electron provides first class support for in-app purchases including
[a tutorial](https://www.electronjs.org/docs/latest/tutorial/in-app-purchases/)
for how to integrate into your app, unfortunately the interface between StoreKit
and Electron doesn't provide a lot of feedback when things aren't working
properly. In this article I'm going to cover some of the challenges and pain
points I uncovered trying to get in-app purchases working in my app
[Touch Typer](https://touch-typer.kochie.io).

But first why am I trying to add in-app purchases? The answer comes from
**Guideline 3.1.1 - Business - Payments - In-App Purchase** of
[Apple's App Review Guidelines](https://developer.apple.com/app-store/review/guidelines/#in-app-purchase)
which states that apps must use Apple's payment service to handle any in-app
purchases. There are exceptions to this rule, back in 2021
[Epic took Apple to court](https://www.theverge.com/2021/9/12/22667694/epic-v-apple-trial-fortnite-judge-yvonne-gonzalez-rogers-final-ruling-injunction-breakdown)
over their walled-garden monopoly and won a sort of compromise where apps can
link to other purchase methods, however Apple still takes a cut for facilitating
the purchase and will alert the user that the purchase method is not authorized
by Apple in a way that looks like a scam warning. So in order to provide the
best user experience Apple's in-app purchases are still the best way to go.

These are the high level steps that we'll follow to get IAP working.

1. Create an in-app purchase item in App Store Connect.
2. Create a draft release and include the in-app purchase as part of the
   release.
3. Implement the store logic in your app.
4. Build a development version of your Electron app for the Mac App Store.
5. Submit your app to the App Store.

- After making the in-app purchase products/subscriptions in App Store Connect
  you can access them via the sandbox which is a development environment you
  developer certificate will grant you access to if your electron app is built
  correctly.
- You need to build with development certificates.
- Sandbox is an isolated environment but you can't access it with `npm dev` you
  need to build the app and run it. `mas-dev` = Sandbox. `mas` = production.
- You need to sign into the sandbox account on the Mac.

## App Store Connect

> While they look different subscriptions and in-app purchases are the same
> thing behind the scenes. The only difference is that subscriptions are
> recurring payments.

After logging into App Store Connect and selecting your application under
**Monetization** of the left hand menu there is an item for In-App Purchases and
Subscriptions. From here you can define different subscriptions and purchases
which can be made in your app, all purchases and subscriptions are treated the
same for our purposes so setting up one will behave exactly like the other. Take
note of the `PRODUCT ID` here as we'll need it later.

![You need to add the in-app purchase as a release](01_app_store_connect.png?width=2000&height=1000)

After you have created the purchase item you can setup a release. IAPs can only
be published to users via a new release, similar to how you would update your
app.

![Create a new app version and add the in-app purchase to the release](02_link_purchase_to_release.png?width=2000&height=1000)

You can select from the list of valid in-app purchases and subscriptions.

![Select the purchase options that users will have access to](06_select_purchase.png?width=700)

Once the purchase option has been added to the release it will appear in the
submission, you can now submit the app to Apple if you wanted to.

![](03_added_purchases.png?width=2000&height=1000)

## Electron

- The electron API for purhcases will only work in the main thread not the
  renderer so you will need to create IPC calls to the main thread to handle the
  purchases.
- If you are building a multi-platform app you will need to handle the different
  platforms differently. Fortunately this is easy to do wih `process.mas` which
  is a boolean that is true if the app is running in the Mac App Store.

- Create the IPC calls your app will need to handle your business logic. Define
  these in the preload script and then expose them to the renderer.

```typescript lineNumbers filename="preload.ts"
declare global {
  namespace NodeJS {
    interface Global {
      ipcRenderer: IpcRenderer
      getProducts: () => Electron.Product[]
      purchaseProduct: (
        productIdentifier: string,
        quantity: number
      ) => Promise<boolean>
      isMas: () => boolean
    }
  }
}

contextBridge.exposeInMainWorld('electronAPI', {
  getProducts: () => ipcRenderer.invoke('getProducts'),
  isMas: () => ipcRenderer.invoke('isMas'),
  purchaseProduct: (productIdentifier: string, quantity: number) =>
    ipcRenderer.invoke('purchaseProduct', productIdentifier, quantity),
})
```

```typescript lineNumbers filename="main.ts"
app.on('ready', async () => {
  ipcMain.handle('getProducts', async () => {
    const products = await getProducts()
    console.log(products)
    return products
  })
  // This is a good way to test if the app is running in the Mac App Store
  ipcMain.handle('isMas', () => !!process.mas || process.env['ELECTRON_IS_MAS'])
  ipcMain.handle(
    'purchaseProduct',
    (event, productIdentifier: string, quantity: number) => {
      console.log(`Purchasing ${productIdentifier}...`)
      console.log(`Quantity: ${quantity}`)
      console.log(`Event: ${event}`)
      return purchaseProduct(productIdentifier, quantity)
    }
  )
})
```

## React

Something to consider when developing with React in Electron is that all IPC
processes are promises, this means that if you rely on an IPC function for
rendering you have to handle asynchronous rendering. This isn't ideal
considering at the time of making this project `suspense` was not stable.

My workaround for this is to create a new hook `useMas` which contains the
context for whether the app is running in a Mac App Store environment. There are
a few advantages to this design - context can be used everywhere, immediately to
render a page so there is no need to use `suspense`. The state of the app is
also maintained throughout the app, no single view holds the sate of the MAS
environment.

```typescript lineNumbers filename="renderer.ts"
import { createContext, useContext, useLayoutEffect, useState } from "react";

type MasContextProps = boolean;

const MasContext = createContext<MasContextProps>(true);

export const MasProvider = ({ children }) => {
  const [_isMas, setMas] = useState<boolean>(true);

  useLayoutEffect(() => {
    // @ts-expect-error
    window.electronAPI.isMas().then(setMas);
  }, []);

  return <MasContext.Provider value={_isMas}>{children}</MasContext.Provider>;
};

export function useMas() {
  return useContext(MasContext);
}
```

![Now with the app setup you can retreive the product data and make purchases](04_products_listed.png?width=600)

## Building a dev app

This is all well and good but we can't actually test with the App Store until we
create a dev build of the app, signed by Apple. If you're using
`electron-builder` it should be as simple as running the following command to
create a new build.

```shell
electron-builder --config electron-builder.config.ts --mac mas-dev
```



![Sandbox purchase success](05_sale_confirmation.png?width=300)

```typescript
if (process.mas) {
  console.log('This is a Mac App Store build')
  // Handle Mac App Store specific behavior here
}
```